---
title: Migrating to Apollo Client 4.0
---

This article walks you through migrating your application to Apollo Client 4.0 from a previous installation of Apollo Client 3.14.

<Note>

If you are migrating from older versions of Apollo Client 3, we generally recommend updating to Apollo Client 3.14 first.
Apollo Client 3.14 introduces a lot of deprecations and warnings that will help you to prepare your application for a smooth migration to Apollo Client 4.0.

</Note>

## Whatâ€™s new in 4.0

- Bundling changes
  - Apollo Client 4.0 now has an `exports` field in it's `package.json` for better ESM support
  - `@apollo/client/core` and `@apollo/client` are now identical and framework-agnostic. React-related exports are now only available in `@apollo/client/react`.
- Enhanced Error Handling
  - network errors are now handled the same way as GraphQL errors and populate the `error` field of a query result
  - the throwing behaviour between network errors and GraphQL errors has been unified
  - `ApolloError` has been removed. A number of new error classes has been introduced, and external errors are now passed through as-is without wrapping them, which allows for easier debugging.
- TypeScript improvements
  - APIs like `client.query` or `useQuery` that accept variables in options will now require the variables to be passed in if any option is non-optional.
  - return types are more precise, taking options into account - if you pass in the `returnPartialData` option, `data` on the return object will be `DeepPartial<TData>`
  - added a new `dataState` property that contains information about the state of the `data` property of a return value. This property can be used to narrow down the type of `data`.
  - most types are now colocated within the API that they relate to, so it is much easier to find the right type for the right situation.
  - some core types like types for `DataMasking` or types representing the that `dataState` narrows down to can now be overwritten.
- Local State changes
  - The local resolver implementation is now a pluggable `LocalState` class to save on bundle size for everyone who doesn't use it.
  - Many improvements and bug fixes in the new `LocalState` implementation
- The `Observable` implementation has been changed to `rxjs`.
- The incremental delivery implementation has been made pluggable, so in the future we can support multiple different versions of the incremental delivery protocol.
- For a full list of changes, please see the [changelog](https://github.com/apollographql/apollo-client/blob/main/CHANGELOG.md).

## Installation

<Caution>

Apollo Client 4.0 is a major-version release that includes breaking changes. If you are updating an existing application to use Apollo Client 4.0, see the [changelog](https://github.com/apollographql/apollo-client/blob/main/CHANGELOG.md) for details about these changes.

</Caution>

Install Apollo Client 4 along with its peer dependencies with the following command:

```
npm install @apollo/client graphql rxjs
```

## Codemod

To ease the migration process, we have created a codemod that will automatically update your codebase to use the new imports and APIs in Apollo Client 4.

This codemod consists of the following steps:

- `imports` step:
  - Updates imports that have moved around, e.g. changing `import { useQuery } from '@apollo/client'` to `import { useQuery } from '@apollo/client/react'`.
  - Updates type references that have moved into namespaces. E.g.
  ```ts
  import { FetchResult } from "@apollo/client";
  fn<FetchResult>();
  ```
  becomes
  ```ts
  import { ApolloLink } from "@apollo/client";
  fn<ApolloLink.Result>();
  ```
- `links` step:
  - In Apollo Client 4, the links have been unified to all be classes. So this step will update your code to use the new class-based links.
    For example, it will change:
  ```ts
  import { createHttpLink } from "@apollo/client";
  const link = createHttpLink({ uri: "https://example.com/graphql" });
  ```
  to:
  ```ts
  import { HttpLink } from "@apollo/client/link/http";
  const link = new HttpLink({ uri: "https://example.com/graphql" });
  ```
  - The `from`, `split` and `concat` functions should now be used as methods on the `ApolloLink` class, so this step will also update your code to use these static methods.
- `removals`
  In Apollo Client 4, a number of exports has been removed for various reasons.
  This step will move all of those imports to point at `@apollo/client/v4-migration`, which is a special migration entry point. All imports from that entry point are type-only and have a DocBlock explaining why the specific export was removed. Many of those DocBlocks also contain migration instructions to help you move away from those removed exports.

### Running the codemod

To run the codemod, you can use the command

```sh
npx @apollo/client-codemod-migrate-3-to-4 src
```

which will behave just like the command line tool `jscodeshift` with a preselected codemod.

Run `npx @apollo/client-codemod-migrate-3-to-4 --help` to see all available options.

### Using the Codemod with TypeScript

If you have a TypeScript project, we recommend running the codemod against `.ts` and `.tsx` files separately as those have slightly overlapping syntax and might otherwise be misinterpreted by the codemod.

```sh
npx @apollo/client-codemod-migrate-3-to-4 --parser ts --extensions ts src
npx @apollo/client-codemod-migrate-3-to-4 --parser tsx --extensions tsx src
```

### Running only specific steps

You can also run the codemod with only specific steps by using the `--codemod` option. For example, to run only the `imports` and `links` steps, you can use:

```sh
npx @apollo/client-codemod-migrate-3-to-4 --codemod imports --codemod links src
```

## Updating imports

If you used the [Codemod](#applying-the-codemod) to update your imports, you can skip this section.
If you did not use the codemod, you will need to manually update your imports to point at the right files.

### Move from manual CJS/ESM imports to `exports`

Apollo Client 4 now has an `exports` field in the `package.json`, which means that you previously used imports like `@apollo/client/react/index.js` or `@apollo/client/react/react.cjs`, you should now use the `@apollo/client/react` entry point.
Your bundler will be aware of the different module formats provided and be able to resolve the right one for you, based on import conditions and the `exports` field of the `package.json`.

<details>
<summary><h3 style="display:inline">List of all changed imports</h3><br/>(click to expand)</summary>

The following entry points have been renamed:
| previous entry point | new entry point |
| --------------------- | -------------------- |
| `@apollo/client/core` | `@apollo/client` |
| `@apollo/client/link/core` | `@apollo/client/link` |
| `@apollo/client/react/context` | `@apollo/client/react` |
| `@apollo/client/react/hooks` | `@apollo/client/react` |
| `@apollo/client/testing/core` | `@apollo/client/testing` |

The following entry points have been removed:
| previous entry point | reason |
| --------------------- | -------------------- |
| `@apollo/client/react/components` | The render prop components were already deprecated in Apollo Client 3.x and have been removed in 4. |
| `@apollo/client/react/hoc` | The higher order components were already deprecated in Apollo Client 3.x and have been removed in 4. |
| `@apollo/client/react/parser` | This module was an implementation detail of the render prop components and HOCs. |
| `@apollo/client/testing/experimental` | This is available as [@apollo/graphql-testing-library](https://github.com/apollographql/graphql-testing-library) |
| `@apollo/client/utilities/globals` | This was an implementation detail and has been removed. Some of the exports are now available in other entry points. |
| `@apollo/client/utilities/subscriptions/urql` | This is supported natively by urql now so we don't ship it anymore. |

The following individual imports have been renamed, moved to new entry points and/or moved into namespaces:

<table>
<thead>
<tr><th>previous entry point</th><th>new entry point</th></tr>
<tr><td>previous import name</td><td>new import name</td></tr>
</thead>
<tbody>
<tr><th>`@apollo/client`</th><th>(unchanged)</th></tr>
<tr><td>`ApolloClientOptions`</td><td>`ApolloClient.Options`</td></tr>
<tr><td>`DefaultOptions`</td><td>`ApolloClient.DefaultOptions`</td></tr>
<tr><td>`DevtoolsOptions`</td><td>`ApolloClient.DevtoolsOptions`</td></tr>
<tr><td>`MutateResult`</td><td>`ApolloClient.MutateResult`</td></tr>
<tr><td>`MutationOptions`</td><td>`ApolloClient.MutateOptions`</td></tr>
<tr><td>`QueryOptions`</td><td>`ApolloClient.QueryOptions`</td></tr>
<tr><td>`RefetchQueriesOptions`</td><td>`ApolloClient.RefetchQueriesOptions`</td></tr>
<tr><td>`RefetchQueriesResult`</td><td>`ApolloClient.RefetchQueriesResult`</td></tr>
<tr><td>`SubscriptionOptions`</td><td>`ApolloClient.SubscribeOptions`</td></tr>
<tr><td>`WatchQueryOptions`</td><td>`ApolloClient.WatchQueryOptions`</td></tr>
<tr><td>`ApolloQueryResult`</td><td>`ObservableQuery.Result`</td></tr>
<tr><td>`FetchMoreOptions`</td><td>`ObservableQuery.FetchMoreOptions`</td></tr>
<tr><td>`SubscribeToMoreOptions`</td><td>`ObservableQuery.SubscribeToMoreOptions`</td></tr>
<tr><th>`@apollo/client`</th><th>`@apollo/client/react`</th></tr>
<tr><td>`ApolloProvider`</td><td>(unchanged)</td></tr>
<tr><td>`createQueryPreloader`</td><td>(unchanged)</td></tr>
<tr><td>`getApolloContext`</td><td>(unchanged)</td></tr>
<tr><td>`skipToken`</td><td>(unchanged)</td></tr>
<tr><td>`useApolloClient`</td><td>(unchanged)</td></tr>
<tr><td>`useBackgroundQuery`</td><td>(unchanged)</td></tr>
<tr><td>`useFragment`</td><td>(unchanged)</td></tr>
<tr><td>`useLazyQuery`</td><td>(unchanged)</td></tr>
<tr><td>`useLoadableQuery`</td><td>(unchanged)</td></tr>
<tr><td>`useMutation`</td><td>(unchanged)</td></tr>
<tr><td>`useQuery`</td><td>(unchanged)</td></tr>
<tr><td>`useQueryRefHandlers`</td><td>(unchanged)</td></tr>
<tr><td>`useReactiveVar`</td><td>(unchanged)</td></tr>
<tr><td>`useReadQuery`</td><td>(unchanged)</td></tr>
<tr><td>`useSubscription`</td><td>(unchanged)</td></tr>
<tr><td>`useSuspenseFragment`</td><td>(unchanged)</td></tr>
<tr><td>`useSuspenseQuery`</td><td>(unchanged)</td></tr>
<tr><td>`ApolloContextValue`</td><td>(unchanged)</td></tr>
<tr><td>`BackgroundQueryHookFetchPolicy`</td><td>`useBackgroundQuery.FetchPolicy`</td></tr>
<tr><td>`BackgroundQueryHookOptions`</td><td>`useBackgroundQuery.Options`</td></tr>
<tr><td>`BaseSubscriptionOptions`</td><td>`useSubscription.Options`</td></tr>
<tr><td>`Context`</td><td>(unchanged)</td></tr>
<tr><td>`LazyQueryExecFunction`</td><td>`useLazyQuery.ExecFunction`</td></tr>
<tr><td>`LazyQueryHookExecOptions`</td><td>`useLazyQuery.ExecOptions`</td></tr>
<tr><td>`LazyQueryHookOptions`</td><td>`useLazyQuery.Options`</td></tr>
<tr><td>`LazyQueryResult`</td><td>`useLazyQuery.Result`</td></tr>
<tr><td>`LazyQueryResultTuple`</td><td>`useLazyQuery.ResultTuple`</td></tr>
<tr><td>`LoadableQueryHookFetchPolicy`</td><td>`useLoadableQuery.FetchPolicy`</td></tr>
<tr><td>`LoadableQueryHookOptions`</td><td>`useLoadableQuery.Options`</td></tr>
<tr><td>`LoadQueryFunction`</td><td>`useLoadableQuery.LoadQueryFunction`</td></tr>
<tr><td>`MutationFunction`</td><td>(unchanged)</td></tr>
<tr><td>`MutationFunctionOptions`</td><td>`useMutation.MutationFunctionOptions`</td></tr>
<tr><td>`MutationHookOptions`</td><td>`useMutation.Options`</td></tr>
<tr><td>`MutationResult`</td><td>`useMutation.Result`</td></tr>
<tr><td>`MutationTuple`</td><td>`useMutation.ResultTuple`</td></tr>
<tr><td>`NoInfer`</td><td>(unchanged)</td></tr>
<tr><td>`OnDataOptions`</td><td>`useSubscription.OnDataOptions`</td></tr>
<tr><td>`OnSubscriptionDataOptions`</td><td>`useSubscription.OnSubscriptionDataOptions`</td></tr>
<tr><td>`PreloadedQueryRef`</td><td>(unchanged)</td></tr>
<tr><td>`PreloadQueryFetchPolicy`</td><td>(unchanged)</td></tr>
<tr><td>`PreloadQueryFunction`</td><td>(unchanged)</td></tr>
<tr><td>`PreloadQueryOptions`</td><td>(unchanged)</td></tr>
<tr><td>`QueryFunctionOptions`</td><td>`useQuery.Options`</td></tr>
<tr><td>`QueryHookOptions`</td><td>`useQuery.Options`</td></tr>
<tr><td>`QueryRef`</td><td>(unchanged)</td></tr>
<tr><td>`QueryReference`</td><td>`QueryRef`</td></tr>
<tr><td>`QueryResult`</td><td>`useQuery.Result`</td></tr>
<tr><td>`QueryTuple`</td><td>`useLazyQuery.ResultTuple`</td></tr>
<tr><td>`SkipToken`</td><td>(unchanged)</td></tr>
<tr><td>`SubscriptionDataOptions`</td><td>(unchanged)</td></tr>
<tr><td>`SubscriptionHookOptions`</td><td>`useSubscription.Options`</td></tr>
<tr><td>`SubscriptionResult`</td><td>`useSubscription.Result`</td></tr>
<tr><td>`SuspenseQueryHookFetchPolicy`</td><td>`useSuspenseQuery.FetchPolicy`</td></tr>
<tr><td>`SuspenseQueryHookOptions`</td><td>`useSuspenseQuery.Options`</td></tr>
<tr><td>`UseBackgroundQueryResult`</td><td>`useBackgroundQuery.Result`</td></tr>
<tr><td>`UseFragmentOptions`</td><td>`useFragment.Options`</td></tr>
<tr><td>`UseFragmentResult`</td><td>`useFragment.Result`</td></tr>
<tr><td>`UseLoadableQueryResult`</td><td>`useLoadableQuery.Result`</td></tr>
<tr><td>`UseQueryRefHandlersResult`</td><td>`useQueryRefHandlers.Result`</td></tr>
<tr><td>`UseReadQueryResult`</td><td>`useReadQuery.Result`</td></tr>
<tr><td>`UseSuspenseFragmentOptions`</td><td>`useSuspenseFragment.Options`</td></tr>
<tr><td>`UseSuspenseFragmentResult`</td><td>`useSuspenseFragment.Result`</td></tr>
<tr><td>`UseSuspenseQueryResult`</td><td>`useSuspenseQuery.Result`</td></tr>
<tr><td>`VariablesOption`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/cache`</th><th>(unchanged)</th></tr>
<tr><td>`WatchFragmentOptions`</td><td>`ApolloCache.WatchFragmentOptions`</td></tr>
<tr><td>`WatchFragmentResult`</td><td>`ApolloCache.WatchFragmentResult`</td></tr>
<tr><th>`@apollo/client/link`</th><th>`@apollo/client/incremental`</th></tr>
<tr><td>`ExecutionPatchIncrementalResult`</td><td>`Defer20220824Handler.SubsequentResult`</td></tr>
<tr><td>`ExecutionPatchInitialResult`</td><td>`Defer20220824Handler.InitialResult`</td></tr>
<tr><td>`ExecutionPatchResult`</td><td>`Defer20220824Handler.Chunk`</td></tr>
<tr><td>`IncrementalPayload`</td><td>`Defer20220824Handler.IncrementalDeferPayload`</td></tr>
<tr><td>`Path`</td><td>`Incremental.Path`</td></tr>
<tr><th>`@apollo/client/link`</th><th>(unchanged)</th></tr>
<tr><td>`FetchResult`</td><td>`ApolloLink.Result`</td></tr>
<tr><td>`GraphQLRequest`</td><td>`ApolloLink.Request`</td></tr>
<tr><td>`NextLink`</td><td>`ApolloLink.ForwardFunction`</td></tr>
<tr><td>`Operation`</td><td>`ApolloLink.Operation`</td></tr>
<tr><td>`RequestHandler`</td><td>`ApolloLink.RequestHandler`</td></tr>
<tr><th>`@apollo/client/link`</th><th>`graphql`</th></tr>
<tr><td>`SingleExecutionResult`</td><td>`FormattedExecutionResult`</td></tr>
<tr><th>`@apollo/client/link/batch`</th><th>(unchanged)</th></tr>
<tr><td>`BatchHandler`</td><td>`BatchLink.BatchHandler`</td></tr>
<tr><th>`@apollo/client/link/context`</th><th>(unchanged)</th></tr>
<tr><td>`ContextSetter`</td><td>`SetContextLink.LegacyContextSetter`</td></tr>
<tr><th>`@apollo/client/link/error`</th><th>(unchanged)</th></tr>
<tr><td>`ErrorHandler`</td><td>`ErrorLink.ErrorHandler`</td></tr>
<tr><td>`ErrorResponse`</td><td>`ErrorLink.ErrorHandlerOptions`</td></tr>
<tr><th>`@apollo/client/link/http`</th><th>`@apollo/client/errors`</th></tr>
<tr><td>`ServerParseError`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/link/persisted-queries`</th><th>(unchanged)</th></tr>
<tr><td>`ErrorResponse`</td><td>`PersistedQueryLink.DisableFunctionOptions`</td></tr>
<tr><th>`@apollo/client/link/remove-typename`</th><th>(unchanged)</th></tr>
<tr><td>`RemoveTypenameFromVariablesOptions`</td><td>`RemoveTypenameFromVariablesLink.Options`</td></tr>
<tr><th>`@apollo/client/link/utils`</th><th>`@apollo/client/errors`</th></tr>
<tr><td>`ServerError`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/link/ws`</th><th>(unchanged)</th></tr>
<tr><td>`WebSocketParams`</td><td>`WebSocketLink.Configuration`</td></tr>
<tr><th>`@apollo/client/react`</th><th>`@apollo/client`</th></tr>
<tr><td>`Context`</td><td>`DefaultContext`</td></tr>
<tr><th>`@apollo/client/react`</th><th>(unchanged)</th></tr>
<tr><td>`QueryReference`</td><td>`QueryRef`</td></tr>
<tr><td>`ApolloProviderProps`</td><td>`ApolloProvider.Props`</td></tr>
<tr><td>`BackgroundQueryHookFetchPolicy`</td><td>`useBackgroundQuery.FetchPolicy`</td></tr>
<tr><td>`BackgroundQueryHookOptions`</td><td>`useBackgroundQuery.Options`</td></tr>
<tr><td>`UseBackgroundQueryResult`</td><td>`useBackgroundQuery.Result`</td></tr>
<tr><td>`LazyQueryExecFunction`</td><td>`useLazyQuery.ExecFunction`</td></tr>
<tr><td>`LazyQueryHookExecOptions`</td><td>`useLazyQuery.ExecOptions`</td></tr>
<tr><td>`LazyQueryHookOptions`</td><td>`useLazyQuery.Options`</td></tr>
<tr><td>`LazyQueryResult`</td><td>`useLazyQuery.Result`</td></tr>
<tr><td>`LazyQueryResultTuple`</td><td>`useLazyQuery.ResultTuple`</td></tr>
<tr><td>`QueryTuple`</td><td>`useLazyQuery.ResultTuple`</td></tr>
<tr><td>`LoadableQueryFetchPolicy`</td><td>`useLoadableQuery.FetchPolicy`</td></tr>
<tr><td>`LoadableQueryHookFetchPolicy`</td><td>`useLoadableQuery.FetchPolicy`</td></tr>
<tr><td>`LoadableQueryHookOptions`</td><td>`useLoadableQuery.Options`</td></tr>
<tr><td>`LoadQueryFunction`</td><td>`useLoadableQuery.LoadQueryFunction`</td></tr>
<tr><td>`UseLoadableQueryResult`</td><td>`useLoadableQuery.Result`</td></tr>
<tr><td>`MutationFunctionOptions`</td><td>`useMutation.MutationFunctionOptions`</td></tr>
<tr><td>`MutationHookOptions`</td><td>`useMutation.Options`</td></tr>
<tr><td>`MutationResult`</td><td>`useMutation.Result`</td></tr>
<tr><td>`MutationTuple`</td><td>`useMutation.ResultTuple`</td></tr>
<tr><td>`BaseSubscriptionOptions`</td><td>`useSubscription.Options`</td></tr>
<tr><td>`OnDataOptions`</td><td>`useSubscription.OnDataOptions`</td></tr>
<tr><td>`OnSubscriptionDataOptions`</td><td>`useSubscription.OnSubscriptionDataOptions`</td></tr>
<tr><td>`SubscriptionHookOptions`</td><td>`useSubscription.Options`</td></tr>
<tr><td>`SubscriptionResult`</td><td>`useSubscription.Result`</td></tr>
<tr><td>`QueryFunctionOptions`</td><td>`useQuery.Options`</td></tr>
<tr><td>`QueryHookOptions`</td><td>`useQuery.Options`</td></tr>
<tr><td>`QueryResult`</td><td>`useQuery.Result`</td></tr>
<tr><td>`SuspenseQueryHookFetchPolicy`</td><td>`useSuspenseQuery.FetchPolicy`</td></tr>
<tr><td>`SuspenseQueryHookOptions`</td><td>`useSuspenseQuery.Options`</td></tr>
<tr><td>`UseSuspenseQueryResult`</td><td>`useSuspenseQuery.Result`</td></tr>
<tr><td>`UseQueryRefHandlersResult`</td><td>`useQueryRefHandlers.Result`</td></tr>
<tr><td>`UseFragmentOptions`</td><td>`useFragment.Options`</td></tr>
<tr><td>`UseFragmentResult`</td><td>`useFragment.Result`</td></tr>
<tr><td>`UseReadQueryResult`</td><td>`useReadQuery.Result`</td></tr>
<tr><td>`UseSuspenseFragmentOptions`</td><td>`useSuspenseFragment.Options`</td></tr>
<tr><td>`UseSuspenseFragmentResult`</td><td>`useSuspenseFragment.Result`</td></tr>
<tr><th>`@apollo/client/react`</th><th>`@apollo/client/utilities/internal`</th></tr>
<tr><td>`NoInfer`</td><td>(unchanged)</td></tr>
<tr><td>`VariablesOption`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/react/internal`</th><th>`@apollo/client/react`</th></tr>
<tr><td>`PreloadedQueryRef`</td><td>(unchanged)</td></tr>
<tr><td>`QueryRef`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/testing`</th><th>(unchanged)</th></tr>
<tr><td>`MockedRequest`</td><td>`MockLink.MockedRequest`</td></tr>
<tr><td>`MockedResponse`</td><td>`MockLink.MockedResponse`</td></tr>
<tr><td>`MockLinkOptions`</td><td>`MockLink.Options`</td></tr>
<tr><td>`ResultFunction`</td><td>`MockLink.ResultFunction`</td></tr>
<tr><th>`@apollo/client/testing`</th><th>`@apollo/client/testing/react`</th></tr>
<tr><td>`MockedProvider`</td><td>(unchanged)</td></tr>
<tr><td>`MockedProviderProps`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/utilities`</th><th>`@apollo/client/utilities/internal`</th></tr>
<tr><td>`argumentsObjectFromField`</td><td>(unchanged)</td></tr>
<tr><td>`AutoCleanedStrongCache`</td><td>(unchanged)</td></tr>
<tr><td>`AutoCleanedWeakCache`</td><td>(unchanged)</td></tr>
<tr><td>`canUseDOM`</td><td>(unchanged)</td></tr>
<tr><td>`checkDocument`</td><td>(unchanged)</td></tr>
<tr><td>`cloneDeep`</td><td>(unchanged)</td></tr>
<tr><td>`compact`</td><td>(unchanged)</td></tr>
<tr><td>`createFragmentMap`</td><td>(unchanged)</td></tr>
<tr><td>`createFulfilledPromise`</td><td>(unchanged)</td></tr>
<tr><td>`createRejectedPromise`</td><td>(unchanged)</td></tr>
<tr><td>`dealias`</td><td>(unchanged)</td></tr>
<tr><td>`decoratePromise`</td><td>(unchanged)</td></tr>
<tr><td>`DeepMerger`</td><td>(unchanged)</td></tr>
<tr><td>`filterMap`</td><td>(unchanged)</td></tr>
<tr><td>`getApolloCacheMemoryInternals`</td><td>(unchanged)</td></tr>
<tr><td>`getApolloClientMemoryInternals`</td><td>(unchanged)</td></tr>
<tr><td>`getDefaultValues`</td><td>(unchanged)</td></tr>
<tr><td>`getFragmentDefinition`</td><td>(unchanged)</td></tr>
<tr><td>`getFragmentDefinitions`</td><td>(unchanged)</td></tr>
<tr><td>`getFragmentFromSelection`</td><td>(unchanged)</td></tr>
<tr><td>`getFragmentQueryDocument`</td><td>(unchanged)</td></tr>
<tr><td>`getGraphQLErrorsFromResult`</td><td>(unchanged)</td></tr>
<tr><td>`getInMemoryCacheMemoryInternals`</td><td>(unchanged)</td></tr>
<tr><td>`getOperationDefinition`</td><td>(unchanged)</td></tr>
<tr><td>`getOperationName`</td><td>(unchanged)</td></tr>
<tr><td>`getQueryDefinition`</td><td>(unchanged)</td></tr>
<tr><td>`getStoreKeyName`</td><td>(unchanged)</td></tr>
<tr><td>`graphQLResultHasError`</td><td>(unchanged)</td></tr>
<tr><td>`hasDirectives`</td><td>(unchanged)</td></tr>
<tr><td>`hasForcedResolvers`</td><td>(unchanged)</td></tr>
<tr><td>`isArray`</td><td>(unchanged)</td></tr>
<tr><td>`isDocumentNode`</td><td>(unchanged)</td></tr>
<tr><td>`isField`</td><td>(unchanged)</td></tr>
<tr><td>`isNonEmptyArray`</td><td>(unchanged)</td></tr>
<tr><td>`isNonNullObject`</td><td>(unchanged)</td></tr>
<tr><td>`isPlainObject`</td><td>(unchanged)</td></tr>
<tr><td>`makeReference`</td><td>(unchanged)</td></tr>
<tr><td>`makeUniqueId`</td><td>(unchanged)</td></tr>
<tr><td>`maybeDeepFreeze`</td><td>(unchanged)</td></tr>
<tr><td>`mergeDeep`</td><td>(unchanged)</td></tr>
<tr><td>`mergeDeepArray`</td><td>(unchanged)</td></tr>
<tr><td>`mergeOptions`</td><td>(unchanged)</td></tr>
<tr><td>`omitDeep`</td><td>(unchanged)</td></tr>
<tr><td>`preventUnhandledRejection`</td><td>(unchanged)</td></tr>
<tr><td>`registerGlobalCache`</td><td>(unchanged)</td></tr>
<tr><td>`removeDirectivesFromDocument`</td><td>(unchanged)</td></tr>
<tr><td>`resultKeyNameFromField`</td><td>(unchanged)</td></tr>
<tr><td>`shouldInclude`</td><td>(unchanged)</td></tr>
<tr><td>`storeKeyNameFromField`</td><td>(unchanged)</td></tr>
<tr><td>`stringifyForDisplay`</td><td>(unchanged)</td></tr>
<tr><td>`toQueryResult`</td><td>(unchanged)</td></tr>
<tr><td>`DecoratedPromise`</td><td>(unchanged)</td></tr>
<tr><td>`DeepOmit`</td><td>(unchanged)</td></tr>
<tr><td>`FragmentMap`</td><td>(unchanged)</td></tr>
<tr><td>`FragmentMapFunction`</td><td>(unchanged)</td></tr>
<tr><td>`FulfilledPromise`</td><td>(unchanged)</td></tr>
<tr><td>`IsAny`</td><td>(unchanged)</td></tr>
<tr><td>`NoInfer`</td><td>(unchanged)</td></tr>
<tr><td>`PendingPromise`</td><td>(unchanged)</td></tr>
<tr><td>`Prettify`</td><td>(unchanged)</td></tr>
<tr><td>`Primitive`</td><td>(unchanged)</td></tr>
<tr><td>`RejectedPromise`</td><td>(unchanged)</td></tr>
<tr><td>`RemoveIndexSignature`</td><td>(unchanged)</td></tr>
<tr><td>`VariablesOption`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/utilities/global`</th><th>`@apollo/client/utilities/environment`</th></tr>
<tr><td>`DEV`</td><td>`__DEV__`</td></tr>
<tr><td>`__DEV__`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/utilities/global`</th><th>`@apollo/client/utilities/internal/globals`</th></tr>
<tr><td>`global`</td><td>(unchanged)</td></tr>
<tr><td>`maybe`</td><td>(unchanged)</td></tr>
<tr><th>`@apollo/client/utilities/global`</th><th>`@apollo/client/utilities/invariant`</th></tr>
<tr><td>`invariant`</td><td>(unchanged)</td></tr>
<tr><td>`InvariantError`</td><td>(unchanged)</td></tr>
<tr><td>`newInvariantError`</td><td>(unchanged)</td></tr>
</tbody>
</table>

</details>

## Replacing removed exports

If you used the [Codemod](#applying-the-codemod) to update your imports, all imports for removed exports have been replaced with imports from `@apollo/client/v4-migration`. You should get a TypeScript error everywhere you use a removed export, and hovering your mouse over it, you get more information about why the export was removed and what you can use instead.

For a list of all removed imports and recommended actions, see [node_modules/@apollo/client/v4-migration.d.ts](https://app.unpkg.com/@apollo/client@^4.0.0-rc/files/v4-migration.d.ts)

## Update your ApolloClient creation

Some of the constructor options of `ApolloClient` have changed around in Apollo Client 4. This section will help you update your `ApolloClient` creation code to the new options.

### Implicitly create a new `HttpLink`

The shorthand annotation where you could pass `uri`, `headers` or `credentials` directly into the `ApolloClient` constructor has been removed.
Instead, you now need to create a new `HttpLink` instance and pass it to the `link` option of `ApolloClient`.

Although it was convenient, it created a direct coupling with `HttpLink`, so even users that were not using `HttpLink` had to ship it in their bundle. This change allows you to use any link implementation you want, without having to ship `HttpLink` if you don't need it.

```ts
import {
  ApolloClient,
  InMemoryCache,
  HttpLink, // [!code ++]
} from "@apollo/client/core";
const client = new ApolloClient({
  // ...
  link: new HttpLink({ // [!code ++]
    uri: "https://example.com/graphql",
    credentials: "include",
    headers: { "x-custom-header": "value" },
  }), // [!code ++]
  // ...
});
```

### Move `name` and `version` into the `clientAwareness` option

```ts
const client = new ApolloClient({
  // ...
  clientAwareness: { // [!code ++]
    name: "My Apollo Client App",
    version: "1.0.0",
  }, // [!code ++]
  // ...
});
```

### If using local state: add a new `LocalState` instance

If you are using `@client` fields, you should create a new `LocalState` instance and pass it to the `ApolloClient` constructor.

```ts
import {
  ApolloClient,
  InMemoryCache,
  LocalState, // [!code ++]
} from "@apollo/client/core";
const client = new ApolloClient({
  // ...
  localState: new LocalState(), // [!code ++]
  // ...
});
```

Additionally, if you are using local resolvers, you should pass the `resolvers` option to the `LocalState` constructor instead of the `ApolloClient` constructor.

```ts
import {
  ApolloClient,
  InMemoryCache,
  LocalState, // [!code ++]
} from "@apollo/client/core";
const client = new ApolloClient({
  // ...
  localState: new LocalState({ // [!code ++]
    resolvers: {
      Query: {
        myField: () => "Hello World",
      },
    },
  }), // [!code ++]
  // ...
});
```

### Change `connectToDevTools` to `devtools.enabled`

The `connectToDevTools` option has been replaced with a new `devtools` option that contains an `enabled` property.

```ts
const client = new ApolloClient({
  // ...
  connectToDevTools: true, // [!code --]
  devtools: { enabled: true }, // [!code ++]
  // ...
});
```

### Change `disableNetworkFetches` to `prioritizeCacheValues`

If you are using the `disableNetworkFetches` option, note that it has been renamed to `prioritizeCacheValues`.

```ts
const client = new ApolloClient({
  // ...
  disableNetworkFetches: ..., // [!code --]
  prioritizeCacheValues: ..., // [!code ++]
  // ...
});
```

### Enable incremental delivery (`@defer`)

In Apollo Client 4, you can swap out the incremental delivery protocol implementation.
That means if you were using `@defer` previously, you should now enable the new `Defer20220824Handler` by passing it to the `incrementalHandler` option.

```ts
import { Defer20220824Handler } from "@apollo/client/incremental"; // [!code ++]
const client = new ApolloClient({
  // ...
  incrementalHandler: new Defer20220824Handler(), // [!code ++]
  // ...
});
```

Additionally, you should enable the `TypeOverrides` for the `Defer20220824Handler`.
This will add the deferred chunk types to `ApolloLink.Result` and ensures that you handle incremental results correctly in custom links that might access `result` directly.

To do so, create a new `.d.ts` file in your project (e.g. `apollo-client.d.ts`) and add the following content:

```ts title="apollo-client.d.ts
import { Defer20220824Handler } from "@apollo/client/incremental"; // [!code highlight]

declare module "@apollo/client" {
  export interface TypeOverrides extends Defer20220824Handler.TypeOverrides {} // [!code highlight]
}
```

<Note>

Over time, we will introduce additional incremental handlers to support different proposals of the protocol.

</Note>

## Enable data masking types

In Apollo Client 4, the data masking types are now pluggable to allow for more flexibility when working with different solutions like GraphQL Code Generator or `gql.tadqa` - which might have different typings for data masking.

To configure the data masking types to be the same as they were in Apollo Client 3, create a `.d.ts` file in your project with the following content:

```ts title="apollo-client.d.ts
import { GraphQLCodegenDataMasking } from "@apollo/client/masking"; // [!code highlight]

declare module "@apollo/client" {
  export interface TypeOverrides // [!code highlight:2]
    extends GraphQLCodegenDataMasking.TypeOverrides {}
}
```

<Note>

You can always combine multiple `TypeOverrides` of different kinds, so you can also combine this with the `Defer20220824Handler` type overrides from the previous section.

```ts title="apollo-client.d.ts
import { Defer20220824Handler } from "@apollo/client/incremental";
import { GraphQLCodegenDataMasking } from "@apollo/client/masking"; // [!code ++]

declare module "@apollo/client" {
  export interface TypeOverrides extends Defer20220824Handler.TypeOverrides {} // [!code --]
  export interface TypeOverrides // [!code ++:3]
    extends Defer20220824Handler.TypeOverrides,
      GraphQLCodegenDataMasking.TypeOverrides {}
}
```

</Note>

## Core API changes

### New `notifyOnNetworkStatusChange` default value

`notifyOnNetworkStatusChange` for `ObservableQuery` instances created by `client.watchQuery` now defaults to `true` instead of `false`.

### Immediate `loading` status emitted by `ObservableQuery`

When you create an `ObservableQuery` with `client.watchQuery`, unless you explicitly disable `notifyOnNetworkStatusChange`, the first emitted value will now always have `loading: true` if the query is not already in the cache.
Previously, this initial loading state would have been skipped.

## For React users

One of Apollo Client 4's focus points is to be more opinionated about how to use Apollo Client.
A big part of that is to ensure that the React hooks are more straightforward to use, for a very specific use case.
We believe that hooks should be used to synchronize data with your component, and not trigger side effects that won't synchronize with your component.
As a result, in some previous use cases, we now recommend to use the core APIs of Apollo Client directly where synchronization with a component is not intended.

As an example, if you were using `useLazyQuery` to trigger many queries in quick succession, but were not interested in synchronizing the result with your component, you should now use `client.query` directly instead of using a hook.

```ts
const [execute] = useLazyQuery(MY_QUERY); // [!code --]
const client = useApolloClient(); // [!code ++]
// ...
await execute({ variables }); // [!code --]
await client.query({ query: MY_QUERY, variables }); // [!code ++]
```

### changes to `useLazyQuery`

`useLazyQuery` has undergone a big rewrite to have a more predictable behaviour.
In Apollo Client 3, once the `useLazyQuery` execute function was called for the first time, it would behave like a regular `useQuery` hook, meaning it would automatically make network requests once options were changed.

In Apollo Client 4, the focus of `useLazyQuery` is more to execute a query on demand in response to user interactions, and synchronize data with the component.

As a result, some major changes have been made:

- `useLazyQuery` no longer accepts a `variables` or `context` option. The previous behaviour where these options were merged together with the `variables` and `context` passed to the execute function has been removed, as it was confusing and hard to predict.
  Instead, you should pass `variables` and `context` directly to the execute function, which will then be used to execute the query.
- The `execute` function no longer accepts any other options than `variables` and `context`. Those options should be passed directly to the hook instead.
- calling the `execute` function of `useLazyQuery` during render is no longer allowed. This also means that it is no longer possible to make queries with `useLazyQuery` during SSR.
- `onCompleted` and `onError` callbacks have been removed from the hook options - if you need to programmatically react to the result of the query, `await` the promise returned by the `execute` function.
- if a new query is started with `execute` while the previous query is still in flight, the previous query will be cancelled and the new query will be started. The previous promise returned by the `execute` function will be rejected with an `AbortError`.
  This means that you can no longer have multiple queries in flight at the same time with `useLazyQuery`.
  To indicate that you are still interested in a query finishing even if it will not reflect in your component UI, you can call `.retain()` on the promise returned by the `execute` function.
  That said, this is usually a sign that you are using `useLazyQuery` to trigger queries and are not interested in synchronizing the result with your component - in that case, you should not use a hook at all, but instead call `client.query` directly.

### changes to `useMutation`

- The `ignoreResults` option of `useMutation` has been removed. If you want to trigger a mutation, but are not interested in synchronizing the result with your component, you should use `client.mutate` directly instead of using a hook.

```ts
const [mutate] = useMutation(MY_MUTATION); // [!code --]
const client = useApolloClient(); // [!code ++]
// ...
await mutate({ variables }); // [!code --]
await client.mutate({ mutation: MY_MUTATION, variables }); // [!code ++]
```

### `useQuery`: `notifyOnNetworkStatusChange` option defaults to `true`

The `notifyOnNetworkStatusChange` option of `useQuery` now defaults to `true` instead of `false` in Apollo Client 3.

### `useQuery`: removal of the deprecated `onCompleted` and `onError` options

The `useQuery` callback options `onCompleted` and `onError` have been removed, as they were easy to accidentally use differently than intended and cause bugs in your application.

You can read up more on this decision and recommendations on what to do instead in the [related GitHub issue](https://github.com/apollographql/apollo-client/issues/12352).

### (optional, but recommended) Stop using generated hooks

Apollo Client 4 comes with a lot of improvements to our hook types. If you are using generated hooks, you will not be able to benefit from these improvements, so we recommend to stop using generated hooks and use our hooks directly with `TypedDocumentNode` instead.

<Note>

The GraphQL Code Generator team is providing a codemod to help you migrate off of generated hooks - you can watch [this video](https://www.youtube.com/watch?v=GGmt0hvnQNU) that introduces it.

Note that that codemod is a separate package and not maintained by the Apollo Client team. Generally, we recommend to use a manual codegen configuration over the client preset shown in the video, as the client preset has some overlapping features with Apollo Client that do not play well together. If you choose to go this route, see [our recommended configuration for the GraphQL Code Generator Client Preset](https://www.apollographql.com/docs/deploy-preview/74d89f8b5deec991d04de44f/react/development-testing/static-typing#the-client-preset), but in the long run also consider rolling your own configuration.

</Note>

### New SSR api `prerenderStatic`

A new `prerenderStatic` API has been added to the `@apollo/client/react/ssr` package.
This API is a replacement for the previous `renderToStringWithData`, `getDataFromTree` and `getMarkupFromTree` APIs, which are now deprecated.

`prerenderStatic` can be used together with the modern [`prerender`](https://react.dev/reference/react-dom/static/prerender) and [`prerenderToNodeStream`](https://react.dev/reference/react-dom/static/prerenderToNodeStream) React APIs, which will enable you to server-side render, even if you are using suspense in your application.
Note that this is still only a step towards full support for streaming SSR, and you might need one of our [framework integrations](https://github.com/apollographql/apollo-client-integrations) to make full use of streaming SSR.

## TypeScript changes

### Moving types into namespaces

Most types are now colocated within the API that they relate to, so it is much easier to find the right type for the right situation.

Some examples:

- `FetchResult` is now `ApolloLink.Result`
- `ApolloClientOptions` is now `ApolloClient.Options`
- `QueryOptions` is now `ApolloClient.QueryOptions`
- `ApolloQueryResult` is now `ObservableQuery.Result`
- `QueryHookOptions` is now `useQuery.Options`
- `QueryResult` is now `useQuery.Result`
- `LazyQueryResult` is now `useLazyQuery.Result`

These renames should be taken care of by running the codemod, but if you are not using the codemod, most of these types will still be available under their old names, with a deprecation note pointing to the new location.

### Removal of `<TContext>` and `<TCacheShape>` generics

Many APIs in Apollo Client 3 used a manual `TContext` generic to pass the context type around. This was extremely fragile, so these generics have been removed in Apollo Client 4. Instead, override the `DefaultContext` type by using module augmentation.

To define types for your custom context properties, create a TypeScript file and define the `DefaultContext` interface.

```ts title="apollo-client.d.ts"
// This import is necessary to ensure all Apollo Client imports
// are still available to the rest of the application.
import "@apollo/client";

declare module "@apollo/client" {
  interface DefaultContext {
    myProperty?: string;
    requestId?: number;
  }
}
```

Similar to `TContext`, the `TCacheShape` generic has been removed from the `ApolloClient` constructor options, because it added a lot of mental overhead with very little benefit. There is no replacement for this generic.

## Changes in tracking of active queries and active observables

In Apollo Client 3, every `ObservableQuery` ever was tracked until it had been unsubscribed from. This could lead to situations where observables would be created, but never subscribed to - and as a result, never unsubscribed and cleaned up, causing memory leaks.

In Apollo Client 4, this behaviour has changed. We only track queries that are currently subscribed to, and once they are unsubscribed from, they are removed from the tracking list.
This changes the meaning of `active` and `inactive` queries from what they were in Apollo Client 3.
In Apollo Client 4, a query is only considered `inactive` if it is currently subscribed to, but skipped by setting the `skip` option in a hook,
passing a `skipToken`, or setting the `fetchPolicy` to `standby`. Other subscribed queries are considered `active`, and any unsubscribed query is not tracked at all.

This changes the behaviour of the `client.getObservableQueries` and `client.refetchQueries` methods, along with the `refetchQueries` option of `client.mutate` and `useMutation`.

## New error handling

Error handling between Apollo Client 3 and 4 has changed significantly.
In Apollo Client 3, every error was wrapped in an `ApolloError` instance, which made it hard to figure out where the error initially came from and could cause problems with observability services.
In Apollo Client 4,

- external errors are passed through if they are error-like objects (any object with a `message` and `name` property).
- non-error-like objects are wrapped in a `UnconventionalError` object, with `name` of `UnconventionalError`, `message` of `"An error of unexpected shape occurred."` and the `cause` property pointing at the originally thrown value.
- GraphQL errors are wrapped in a `CombinedGraphQLErrors` object
- a few other error classes have been added to represent specific error cases, such as `ServerParseError`, and `ServerError`.
- the `errors` property that was present next to the `error` property on some interfaces like `ApolloQueryResult` (returned by `ApollClient.query` and emitted by `ObservableQuery`) or `QueryResult` (returned by `useQuery`) has been removed. Instead, access these errors through the `error` property, which is now an instance of `CombinedGraphQLErrors` if there are any GraphQL errors.

You can read up on all available error classes and how to handle them in the [Error Handling](../react/data/error-handling) documentation and the API reference "Errors" section.

Additionally, previously errors from the link chain were handled differently than GraphQL errors.
In Apollo Client 4, all errors are handled in the same way, so you can use `errorPolicy` to control how all kinds of error are handled, not only GraphQL errors.

### Core API error handling changes

If you use `client.watchQuery` to get an `ObservableQuery`, that will now emit an object with an `error` property instead of throwing an error.
This way you can still receive cache updates or call `refetch` without having to resubscribe to the observable.

### React-specific error handling changes

So if you take this code snippet from Apollo Client 3:

```tsx title="error handling with useQuery in Apollo Client 3"
import { useQuery } from "@apollo/client/react";

function ShowingSomeErrors() {
  const { loading, error, data } = useQuery(MY_QUERY);

  if (error) {
    return (
      <div>
        <h2>Error</h2>
        <pre>
          {error.graphQLErrors.map(({ message }) => message).join(", ")}
        </pre>
      </div>
    );
  }
  // other logic
}
```

We have two key observations here:

- `error` was previously always guaranteed to be an `ApolloError` instance, so we could access `error.graphQLErrors` directly.
- `errorPolicy` was only applied to GraphQL errors, so if a network error occurred, that would be `throw`n and needed to be handled outside of the component.

The same snippet with Apollo Client 4 would look like this:

```tsx title="error handling with useQuery in Apollo Client 4"
import { useQuery } from "@apollo/client/react";
import { CombinedGraphQLErrors } from "@apollo/client"; // [!code highlight]

function ShowingSomeErrors() {
  const { loading, error, data } = useQuery(MY_QUERY);

  if (CombinedGraphQLErrors.is(error)) { // [!code highlight]
    return (
      <div>
        <h2>Error</h2>
        <pre>{error.errors.map(({ message }) => message).join(", ")}</pre>{/*[!code highlight]*/}
      </div>
    );
  } else if (error) { // [!code highlight:9]
    // Handle non-GraphQL errors here
    return (
      <div>
        <h2>Error</h2>
        <pre>{error.message}</pre>
      </div>
    );
  }
  // other logic
}
```

So the major changes are:

- `error` is no longer guaranteed to be an `ApolloError` instance, so you need to check if it is a `CombinedGraphQLErrors` instance by calling `CombinedGraphQLErrors.is`
- you can also pass `undefined` to `CombinedGraphQLErrors.is`, no need to check if `error` is defined first
- `error.graphQLErrors` has been replaced with `error.errors`, which is an array of objects as returned from the server, with a shape of `GraphQLFormattedError`
- all error classes shipping with Apollo-Client 4 have a static `is` method that you can use to check if an error is of that type, so you can use `ServerParseError.is(error)` or `ServerError.is(error)` to check for those specific error types.
- additional error handling logic is needed to handle all the other possible errors.
- previously, `result.errors` was available as a shortcut to access the `error.graphQLErrors` array, but this has been removed.

<Note>

If you want to distinguish if an error originated from the link chain or was thrown in a userland callback, you can use `LinkError.is`.
While `LinkError` is not an actual error class (error-like link errors are just passed through), `LinkError.is` will destinguish between link errors and userland errors.

</Note>

<Tip>

Going forward, we recommend using our suspenseful hooks `useSuspenseQuery` and `useBackgroundQuery`/`useReadQuery`.

These hooks will not expose errors to your component but instead throw them, so you can handle all error in a surrounding `ErrorBoundary`.

</Tip>

## Link API changes

### All links are now available as classes

All links are now available as classes. While the old function link creators are still around, they are deprecated and will be removed in a future version.

| old link creator              | new link class                    |
| ----------------------------- | --------------------------------- |
| `setContext`                  | `SetContextLink`                  |
| `onError`                     | `ErrorLink`                       |
| `createHttpLink`              | `HttpLink`                        |
| `createPersistedQueryLink`    | `PersistedQueryLink`              |
| `removeTypenameFromVariables` | `RemoveTypenameFromVariablesLink` |

<Caution>

Pay attention when migrating from the old `setContext` creator to the new `SetContextLink` class.
The arguments to the callback have changed, so you need to swap the order of `prevContext` and `operation`.

```ts
import { setContext } from "@apollo/client/link/context"; // [!code --]
import { SetContextLink } from "@apollo/client/link/context"; // [!code ++]

const authLink = setContext((operation, prevContext) => { /*...*/ } // [!code --]
const authLink = new SetContextLink((prevContext, operation) => { /*...*/ }  // [!code ++]
```

</Caution>

### `from`, `concat`, and `split` exports deprecated

Instead of using the `from`, `concat`, and `split` exports from `@apollo/client/link/core`, please now use the `ApolloLink.from`, `ApolloLink.concat`, and `ApolloLink.split` methods.

### `ApolloLink` usage pattern of `from` and `concat` now aligned with the native `Array` class

The static `ApolloLink.concat` method is now deprecated.
Instead, use the static `ApolloLink.from` method.

`ApolloLink.prototype.concat` now accepts a dynamic number of arguments.

This aligns this API with the `Array.from` and `Array.prototype.concat` methods, which should make these methods more familiar to to work with for JavaScript developers.

```ts
import { ApolloLink } from "@apollo/client/link";
ApolloLink.concat(firstLink, secondLink); // [!code --]
ApolloLink.from([firstLink, secondLink]); // [!code ++]

link1.concat(link2).concat(link3); // [!code --]
link1.concat(link2, link3); // [!code ++]
```

### `ApolloLink` `from,concat,split` static and instance methods now require `ApolloLink` instances

These methods previously accepted `ApolloLink` instances or operator functions as arguments.
Now, they only accept `ApolloLink` instances.

```ts
ApolloLink.from(
  (operation, forward) => { // [!code --:3]
    /*...*/
  },
  new ApolloLink((operation, forward) => { // [!code ++:3]
    /*...*/
  }),
  nextLink
);
```

### ErrorLink argument changes

The `ErrorLink` (previously created with `onError`) now uses a single `error` property instead of separate `graphQLErrors`, `networkError`, and `protocolErrors`.

With built-in error classes, use `ErrorClass.is` to check for specific error types.
For external error types like `TypeError`, use `instanceof` or the more modern [`Error.isError`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/isError#instanceof_vs._error.iserror) in combination with a check for `error.name` to check the kind of error.

```ts
import {
  onError, // [!code --]
  ErrorLink, // [!code ++]
} from "@apollo/client/link/error";
import { CombinedGraphQLErrors, ServerError } from "@apollo/client"; // [!code ++]

const errorLink = onError( // [!code --:12]
  ({ graphQLErrors, networkError, protocolErrors, response }) => {
    if (graphQLErrors) {
      graphQLErrors.forEach(({ message }) =>
        console.log(`GraphQL error: ${message}`)
      );
    }
    if (networkError) {
      console.log(`Network error: ${networkError.message}`);
    }
  }
);
const errorLink = new ErrorLink(({ error, result }) => { // [!code ++:11]
  if (CombinedGraphQLErrors.is(error)) {
    error.errors.forEach(({ message }) =>
      console.log(`GraphQL error: ${message}`)
    );
  } else if (ServerError.is(error)) {
    console.log(`Server error: ${error.message}`);
  } else if (error) {
    console.log(`Other error: ${error.message}`);
  }
});
```

<Note>

If the error thrown in the link chain is not an error-like object, it will be wrapped in an `UnconventionalError` class - so it is always safe to access `error.message` and `error.name` on the `error` object.

</Note>

### `ApolloLink` operation and context changes

The `operation` object passed to the `ApolloLink` methods has changed.

- the `cache` property has been removed
- instead, the `client` property is now available, which contains the `ApolloClient` instance
- you can now access the cache instance via `operation.client.cache`
- `operationName` is now a string if the operation has a name, or `undefined` if it does not
- a new property `operationType` has been added, which can be used to more easily determine if an operation is a `"query"`, `"mutation"` or `"subscription"`.
- the `context` property returned by `operation.getContext()` is now typed as `ReadOnly` to prevent accidental mutations that might not propagate correctly
- the `context` type can be extended by declaration merging to allow for custom properties to align with your links.
  For example, to make your context type-safe for usage with `HttpLink`, place this snippet in a `.d.ts` file in your project:

```ts title="apollo-client.d.ts"
import { HttpLink } from "@apollo/client";

declare module "@apollo/client" {
  interface DefaultContext extends HttpLink.ContextOptions {}
}
```

### `ApolloLink.execute` and `execute` method changes

### Notes for custom link implementations

#### Observable API changes

In Apollo Client 4, the underlying `Observable` implementation has changed from using `zen-observable` to using `rxjs` `Observable` instances.

This can affect custom link implementations that rely on the `Observable` API.

If you were previously using the `map`, `filter`, `reduce`, `flatMap` or `concat` methods on the `Observable` instances, you will need to update your code to use the `rxjs` equivalents.

Additionally, if you were using `Obervable.of` or `Observable.from`, you will need to use the `rxjs` `of` or `from` functions instead.

```ts
import { of, from, map } from "rxjs"; // [!code ++]

Observable.of(1, 2, 3); // [!code --]
of(1, 2, 3); // [!code ++]
Observable.from([1, 2, 3]); // [!code --]
from([1, 2, 3]); // [!code ++]
observable.map((x) => x * 2); // [!code --]
observable.pipe(map((x) => x * 2)); // [!code ++]
```

A good way to find the operator you need is to follow the [rxjs operator decision tree](https://rxjs.dev/operator-decision-tree).

## Local state changes

Local state management (using `@client` fields) has been moved out into the `LocalState` class.
This allows for users that don't use local state to save on bundle size. It you use `@client` directives, either with `TypePolicy` `read` fields or with `resolvers`, you need to create a new `LocalState` instance and pass it to the `ApolloClient` constructor.

If you fail to do so, during development an error will be thrown, and in production, results might be less predictable. (Jerel to add more context about consequences here.)

### Local resolvers changes

Local resolvers are now a part of the `LocalState` class, so you need to pass them to the `LocalState` constructor instead of the `ApolloClient` constructor.

Generally, local resolvers should now behave more consistently and have gained some capabilities **link updated resolver docs here**

## Testing-related changes

A lot of utilities that were previously part of the `@apollo/client/utilities` and `@apollo/client/testing` packages have been removed. They were used for internal testing purposes and we are not using them anymore, so we removed them.

### `MockedProvider` changes

#### default "realistic" `delay`

If no `delay` is specified in mocks, MockLink now default to the `realisticDelay` function, which uses a random delay between 20 and 50ms to ensure tests handle loading states.

If you want to restore the previous behaviour of "no delay", you can set it via

```ts
MockLink.defaultOptions = {
  delay: 0,
};
```

#### Removed `createMockClient` and `mockSingleLink`

The `createMockClient` and `mockSingleLink` utilities have been removed. Instead, you can now use the `MockLink` class directly to create a mock link and pass it into a new `ApolloClient` instance.

## Bundling changes

### `exports` field in package.json

Apollo Client 4 now uses the `exports` field in its `package.json` to define which files are available for import. This means you should now be able to use `import { ApolloClient } from "@apollo/client"` instead of `import { ApolloClient } from "@apollo/client/index.js"` or `import { ApolloClient } from "@apollo/client/main.cjs"`.

### New transpilation target, no shipped polyfills

Apollo Client is now transpiled to target a `since 2023, node >= 20, not dead` target. This means that Apollo Client can now use modern JavaScript features without downlevel transpilation, which will generally result in better performance and smaller bundle size.
We also have stopped the practice of shipping polyfills.

Please note that we might bump the transpilation target to more modern targets in upcoming minor versions. See our [dependency support policy](TODO in separate PR) for more details on the supported environments.

If you are targeting older browsers or special environments, you might need to adjust your build configuration to transpile the Apollo Client library itself to a lower target, or polyfill the missing features yourself.

### Development mode changes

Previously, you had to set a global `__DEV__` variable to `false` to disable development mode.
Now, development mode is primarily controlled by the `development` export condition of the `package.json` exports field. Most modern bundlers should now automatically pick correctly between the development and production version of Apollo Client based on your build environment.

If your build tooling does not support the `development` or `production` export condition, Apollo Client falls back to the previous behaviour, meaning that you can still set the `__DEV__` global variable to `false` to disable development mode in those cases.

## Other notable breaking changes

### `InMemoryCache` `canonizeResults` option removed

The `canonizeResults` option has been removed. It could easily lead to memory leaks. The results returned by `ObservableQuery` are already very stable, so this option rarely had any benefit.

### New requirements for custom cache implementations

Custom cache implementations must now implement the `fragmentMatches` method, which is required for fragment matching in Apollo Client 4.
